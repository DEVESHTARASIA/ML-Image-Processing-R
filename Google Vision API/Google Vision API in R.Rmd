---
title: "Google Vision API in R"
author: "Scott Stoltzman"
date: "7/29/2017"
output: html_document
---

## Using the Google Vision API in R  

### Utilizing RoogleVision  

After doing my post last month on OpenCV and face detection, I started looking into other algorithms used for pattern detection in images. As it turns out, Google has done a phenomenal job with their Vision API. It's absolutely incredible the amount of information it can spit back to you by simply sending it a picture.  

Also, it's 100% free! I believe that includes 1000 images per month. Amazing!  

In this post I'm going to walk you through the absolute basics of accessing the power of the Google Vision API using the RoogleVision package in R.

As always, we'll start off loading some libraries. I wrote some extra notation around where you can install them within the code.  

```{r setup, message=FALSE, warning=FALSE}
# Normal Libraries
library(tidyverse)

# devtools::install_github("flovv/RoogleVision")
library(RoogleVision)
library(jsonlite) # to import credentials

# For image processing
# source("http://bioconductor.org/biocLite.R")
# biocLite("EBImage")
library(EBImage)

# For Latitude Longitude Map
library(leaflet)
```

#### Google Authentication  

In order to use the API, you have to authenticate. There is plenty of documentation out there about how to setup an account, create a project, download credentials, etc. Head over to [Google Cloud Console](https://console.cloud.google.com) if you don't have an account already.

```{r}
# Credentials file I downloaded from the cloud console
creds = fromJSON('credentials.json')

# Google Authentication - Use Your Credentials
# options("googleAuthR.client_id" = "xxx.apps.googleusercontent.com")
# options("googleAuthR.client_secret" = "")

options("googleAuthR.client_id" = creds$installed$client_id)
options("googleAuthR.client_secret" = creds$installed$client_secret)
options("googleAuthR.scopes.selected" = c("https://www.googleapis.com/auth/cloud-platform"))
googleAuthR::gar_auth()
```
  
  
### Now You're Ready to Go  

The function getGoogleVisionResponse takes three arguments:

  1. imagePath
  2. feature
  3. numResults

Numbers 1 and 3 are self-explanatory, "feature" has 5 options:  

  * LABEL_DETECTION
  * LANDMARK_DETECTION
  * FACE_DETECTION
  * LOGO_DETECTION
  * TEXT_DETECTION  

Again, these are self-explanatory but it's nice to see each one in action. 

#### Label Detection  

This is used to help determine context of the photo. It can basically add a level of metadata around the image.  

Here is a photo of our dog when we hiked up to Audubon Peak in Colorado:  


```{r}
dog_mountain_label = getGoogleVisionResponse('dog_mountain.jpg',
                                              feature = 'LABEL_DETECTION')
dog_mountain_label
```
  
  
All 5 responses were incredibly accurate! The "score" that is returned is how confident the Google Vision algorithms are, so it said there's a 91.9% chance a mountain is prominent in this photo. I like "dog hiking" the best - considering that's what we were doing at the time. Kind of a little bit too accurate...

#### Landmark Detection  

This is a feature designed to specifically pick out a recognizable landmark! It provides the position in the image along with the geolocation of the landmark (in longitude and latitude).  

Here is a picture of my wife and me in Germany at the Linderhof Castle in Bavaria, Germany.  

```{r}
us_landmark = getGoogleVisionResponse('us_castle_2.jpg',
                                      feature = 'LANDMARK_DETECTION')
us_landmark
```

It only returned 1 result, but it was spot on. While it had a low score, it's due to the fact I lowered the image resolution in order to be able to "plot" the image in R.

```{r}
us_castle <- readImage('us_castle_2.jpg')
plot(us_castle)
xs = us_landmark$boundingPoly$vertices[[1]][1][[1]]
ys = us_landmark$boundingPoly$vertices[[1]][2][[1]]
polygon(x=xs,y=ys,border='red',lwd=4)
```



```{r}
latt = us_landmark$locations[[1]][[1]][[1]]
lon = us_landmark$locations[[1]][[1]][[2]]
m = leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = lon, lat = latt, zoom = 5) %>%
  addMarkers(lng = lon, lat = latt)
m
```


```{r}
us_dog_mountain_face = getGoogleVisionResponse('us_dog_mountain.jpg',
                                            feature = 'FACE_DETECTION')
us_dog_mountain_face
```

